{% extends 'user_base.html' %}
{% load static %}

{% block title %}Manage Doctors{% endblock %}

{% block content %}
<div class="container py-4">
  <!-- Add Doctor Button -->
  <div class="d-flex justify-content-end mb-3">
    <button class="btn btn-primary" id="addDoctor">+ Add Doctor</button>
  </div>

  <!-- Doctors Table -->
  <div class="card shadow-sm">
    <div class="table-responsive">
      <table class="table align-middle table-hover mb-0">
        <thead class="table-light">
          <tr>
            <th>#</th>
            <th>Name</th>
            <th>Email</th>
            <th>Address</th>
            <th>Phone</th>
            <th>Gender</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          {% for doctor in doctors %}
          <tr>
            <td>{{ forloop.counter }}</td>
            <td>{{ doctor.first_name }} {{ doctor.last_name }}</td>
            <td>{{ doctor.email }}</td>
            <td>{{ doctor.details.address|slice:":20" }}...</td>
            <td>{{ doctor.details.phone_number }}</td>
            <td>{{ doctor.details.gender|capfirst }}</td>
            <td>
              <!-- Edit Button -->
              <button class="btn btn-sm btn-warning text-white" title="Edit Doctor" data-bs-toggle="modal"
                data-bs-target="#doctorModal" onclick="editDoctor(
                  '{{ doctor.id }}', 
                  '{{ doctor.first_name }}',
                  '{{ doctor.last_name }}',
                  '{{ doctor.email }}',
                  '{{ doctor.details.phone_number }}',
                  '{{ doctor.details.gender }}',
                  '{{ doctor.details.address }}',
                  `{{ doctor.specializations|join:"  " }}`
                )">
                <i class="bi bi-pencil-square"></i>
              </button>

              <!-- Delete Button -->
              <form action="{% url 'delete_doctor' doctor.id %}" method="post" class="d-inline" 
                    onsubmit="return confirm('Are you sure you want to remove this Doctor?');">
                {% csrf_token %}
                <button type="submit" class="btn btn-link text-secondary p-0 m-0 remove-cross" style="font-size: 1rem;"
                        title="Remove">
                  <i class="bi bi-x-circle"></i>
                </button>
              </form>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="7" class="text-center">No doctors found.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Doctor Modal -->
<!-- Doctor Modal -->
<div class="modal fade" id="doctorModal" tabindex="-1" aria-labelledby="doctorModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <form method="POST" id="doctorForm" action="{% url 'add_doctors' %}">
      {% csrf_token %}
      <input type="hidden" name="doctor_id" id="doctorId" />
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="doctorModalTitle">Add Doctor</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <div class="row g-3">
            <!-- Specialization -->
            <div class="col-md-12">
              <div class="col-md-12">
                <!-- Container to display the selected specializations -->
                <div id="selectedSpecializations" class="mt-2"></div>
                <label for="specializations" class="form-label">Select Specializations <span
                    class="text-danger">*</span></label>
                <select class="form-select" id="specializations" name="specializations" required>
                  <option value="" disabled selected>-- Select Specialization --</option>
                  {% for specialization in specializations %}
                  <option value="{{ specialization.id }}" data-name="{{ specialization.name }}">{{ specialization.name }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>

            <!-- First Name -->
            <div class="col-md-6">
              <label for="firstName" class="form-label">First Name <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="firstName" name="first_name" required>
            </div>

            <!-- Last Name -->
            <div class="col-md-6">
              <label for="lastName" class="form-label">Last Name <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="lastName" name="last_name" required>
            </div>

            <!-- Email -->
            <div class="col-md-6">
              <label for="email" class="form-label">Email <span class="text-danger">*</span></label>
              <input type="email" class="form-control" id="email" name="email" required>
            </div>

            <!-- Phone Number -->
            <div class="col-md-6">
              <label for="phone" class="form-label">Phone Number <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="phone" name="phone_number" required>
            </div>

            <!-- Gender -->
            <div class="col-md-6">
              <label class="form-label d-block">Gender <span class="text-danger">*</span></label>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="gender" id="male" value="male" required>
                <label class="form-check-label" for="male">Male</label>
              </div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="gender" id="female" value="female" required>
                <label class="form-check-label" for="female">Female</label>
              </div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="gender" id="others" value="others" required>
                <label class="form-check-label" for="others">Others</label>
              </div>
            </div>

            <!-- Address -->
            <div class="col-md-12">
              <label for="address" class="form-label">Address<span class="text-danger">*</span></label>
              <textarea class="form-control" id="address" name="address" rows="2" required></textarea>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="submit" class="btn btn-success">Save Doctor</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </div>
    </form>
  </div>
</div>

{% endblock %}

{% block javascript %}
{{ block.super }}
<!-- Bootstrap JS Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
  {% if messages %}
  {% for message in messages %}
  showSwal("{{ message }}", "{{ message.tags }}");
  {% endfor %}
  {% endif %}


  const doctorModal = document.getElementById('doctorModal');
  // Reset form when modal is closed
  doctorModal.addEventListener("hidden.bs.modal", function () {
    doctorForm.reset();
    resetDoctorForm();
  });

  document.getElementById('addDoctor').addEventListener('click', () => {
    const modal = new bootstrap.Modal(doctorModal);
    document.getElementById('doctorModalTitle').textContent = 'Add a Doctor';
    document.getElementById('doctorId').value = '-1'; // not empty string
    resetDoctorForm(); // Function to clear form data before opening modal
    modal.show();
  });

  // Function to reset the form data
  function resetDoctorForm() {
    document.getElementById('doctorForm').reset();
    // Reset all gender radio buttons to unchecked
    const genderRadios = document.querySelectorAll('input[name="gender"]');
    genderRadios.forEach(radio => radio.checked = false);
    resetSpecializations();
  }
  // Function to reset the selected specializations
  function resetSpecializations() {
    const selectedSpecializationsContainer = document.getElementById('selectedSpecializations');
    selectedSpecializationsContainer.innerHTML = ''; // Clear all displayed specializations
  }

  function editDoctor(id, firstName, lastName, email, phoneNumber, gender, address, specializations, profileImageUrl) {
    // Set the values to the modal fields
    document.getElementById('doctorId').value = id;
    document.getElementById('firstName').value = firstName;
    document.getElementById('lastName').value = lastName;
    document.getElementById('email').value = email;
    document.getElementById('phone').value = phoneNumber;
    document.getElementById('address').value = address;

    // Set gender radio button based on existing data
    if (gender === 'male') {
      document.getElementById('male').checked = true;
    } else if (gender === 'female') {
      document.getElementById('female').checked = true;
    } else if (gender === 'others') {
      document.getElementById('others').checked = true;
    }

    // Handle profile image (if any)
    /*const profileImageInput = document.getElementById('profileImage');
    if (profileImageUrl && profileImageUrl !== 'null') {
      profileImageInput.value = profileImageUrl;
      document.getElementById('profileImagePreview').src = profileImageUrl;  // Assuming you have a preview element
    } else {
      profileImageInput.value = '';
      document.getElementById('profileImagePreview').src = '';  // Reset preview if no image
    }*/

    // Handle specializations (you can adjust this based on how you're storing them)
    const specializationSelect = document.getElementById('specializations');
    let selectedSpecializations = specializations.split(',');  // Assuming it's a comma-separated string of names
    Array.from(specializationSelect.options).forEach(option => {
      option.selected = selectedSpecializations.includes(option.value);  // Mark the relevant options as selected
    });
  }

  document.getElementById('specializations').addEventListener('change', function () {
    const selectElement = document.getElementById('specializations');
    console.log(selectElement);
    const selectedOptions = Array.from(selectElement.selectedOptions);
    console.log(selectedOptions)
    selectedOptions.forEach(option => {
      const specializationId = option.value;
      const specializationName = option.getAttribute('data-name');

      // Only process if the value is not an empty string (invalid selection)
      if (specializationId && specializationId !== "") {
        // Check if this specialization is already displayed
        if (!document.getElementById('selected-' + specializationId)) {
          addSpecialization(specializationId, specializationName);
        }
      }

      // Deselect the option to prevent adding duplicates
      option.selected = false;
    });
  });


  // Function to add selected specialization to the display area
  function addSpecialization(id, name) {
    const selectedSpecializationsContainer = document.getElementById('selectedSpecializations');

    // Create a new div to hold the specialization and the cross button
    const specializationDiv = document.createElement('div');
    specializationDiv.id = 'selected-' + id;
    specializationDiv.classList.add('badge', 'bg-primary', 'm-1', 'd-inline-flex', 'align-items-center');
    specializationDiv.innerHTML = `${name} <button type="button" class="btn-close ms-2" onclick="removeSpecialization('${id}')"></button>`;

    // Append to the container
    selectedSpecializationsContainer.appendChild(specializationDiv);
  }

  // Function to remove specialization from the list
  function removeSpecialization(id) {
    const specializationDiv = document.getElementById('selected-' + id);
    if (specializationDiv) {
      specializationDiv.remove();

      // Optionally, you could manually manage the selections in the select element,
      // but since the selection is deselected immediately after it is added, it won't persist.
      const selectElement = document.getElementById('specializations');
      const option = Array.from(selectElement.options).find(option => option.value === id);
      if (option) {
        option.selected = false;
      }
    }
  }

</script>

{% endblock %}